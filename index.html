<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ø­Ø³Ø¨ Ø¯Ø§Ø¦Ø±Ø©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <style>
    #map { height: 100vh; }
    .popup-style { font-family: Tahoma, sans-serif; font-size: 14px; }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  const map = L.map('map').setView([28, -12], 8);
  const ESRI_API_KEY = 'ğŸ”‘ Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§';

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù…
  const drawnItems = new L.FeatureGroup().addTo(map);
  const drawControl = new L.Control.Draw({
    draw: {
      polygon: false,
      polyline: false,
      rectangle: false,
      marker: false,
      circlemarker: false,
      circle: {
        shapeOptions: {
          color: '#ff0000'
        },
        showRadius: true,
        metric: true
      }
    },
    edit: {
      featureGroup: drawnItems,
      edit: false,
      remove: true
    }
  });
  map.addControl(drawControl);

  // Ø£Ø®Ø° Ø¹ÙŠÙ†Ø§Øª Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
  async function getElevationStats(circle) {
    const center = circle.getLatLng();
    const radius = circle.getRadius(); // Ø¨Ø§Ù„Ø£Ù…ØªØ§Ø±
    const samples = 40;
    const points = [];

    for (let i = 0; i < samples; i++) {
      const angle = (2 * Math.PI * i) / samples;
      const dx = radius * Math.cos(angle);
      const dy = radius * Math.sin(angle);
      const destination = L.latLng(center.lat + (dy / 111320), center.lng + (dx / (40075000 * Math.cos(center.lat * Math.PI / 180) / 360)));
      points.push([destination.lng, destination.lat]);
    }

    const url = `https://elevation.arcgis.com/arcgis/rest/services/Tools/ElevationSync/GPServer/Profile/execute?f=json&token=${ESRI_API_KEY}&ProfileID=1&InputLineFeatures={"features":[{"geometry":{"paths":[${JSON.stringify(points)}],"spatialReference":{"wkid":4326}}}],"geometryType":"esriGeometryPolyline","sr":{"wkid":4326}}`;

    const res = await fetch(url);
    const data = await res.json();
    try {
      const profile = data.results[0].value.features.map(f => f.attributes.Alt);
      const max = Math.max(...profile);
      const min = Math.min(...profile);
      const avg = profile.reduce((a, b) => a + b, 0) / profile.length;

      circle.bindPopup(`
        <div class="popup-style">
          <b>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©:</b><br>
          â›° Ø£Ø¹Ù„Ù‰: ${max.toFixed(2)} Ù…<br>
          â›° Ø£Ø¯Ù†Ù‰: ${min.toFixed(2)} Ù…<br>
          ğŸ“Š Ù…ØªÙˆØ³Ø·: ${avg.toFixed(2)} Ù…
        </div>
      `).openPopup();
    } catch (e) {
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ù…ÙØªØ§Ø­ API.");
    }
  }

  // Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø³Ù…
  map.on(L.Draw.Event.CREATED, function (event) {
    drawnItems.clearLayers();
    const layer = event.layer;
    drawnItems.addLayer(layer);
    getElevationStats(layer);
  });
</script>
</body>
</html>
