<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ù†ØµØ© Ù‚Ù„Ø¨ÙŠ - Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background: #f9f9f9;
      color: #333;
    }
    header {
      background-color: #b30000;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
    }
    #map {
      height: 65vh;
      width: 100%;
    }
    .controls {
      padding: 1rem;
      background: white;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    select,
    button,
    input {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      font-size: 0.9rem;
      border-radius: 6px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <header>Ù…Ù†ØµØ© Ù‚Ù„Ø¨ÙŠ - Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…</header>

  <div class="controls">
    <label>Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</label>
    <select id="bloodType">
      <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>
      <option value="A+">A+</option>
      <option value="A-">A-</option>
      <option value="B+">B+</option>
      <option value="B-">B-</option>
      <option value="AB+">AB+</option>
      <option value="AB-">AB-</option>
      <option value="O+">O+</option>
      <option value="O-">O-</option>
    </select>
    <button onclick="filterMarkers()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶</button>

    <hr />

    <h3>ğŸ©¸ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ·Ù„Ø¨ Ø¯Ù…</h3>

    <input type="text" id="regPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
    <select id="regGender">
      <option value="neutral">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>
      <option value="male">Ø°ÙƒØ±</option>
      <option value="female">Ø£Ù†Ø«Ù‰</option>
    </select>
    <select id="regBlood">
      <option disabled selected>ÙØ¦Ø© Ø§Ù„Ø¯Ù…</option>
      <option value="A+">A+</option>
      <option value="A-">A-</option>
      <option value="B+">B+</option>
      <option value="B-">B-</option>
      <option value="AB+">AB+</option>
      <option value="AB-">AB-</option>
      <option value="O+">O+</option>
      <option value="O-">O-</option>
    </select>

    <button onclick="registerUser()">ØªØ³Ø¬ÙŠÙ„ ÙƒÙ…Ø³ØªØ®Ø¯Ù…</button>
    <button onclick="sendBloodRequest()">Ø·Ù„Ø¨ Ø¯Ù… Ø§Ù„Ø¢Ù†</button>

    <hr />

    <h3>â¤ï¸ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¨Ø±Ø¹</h3>
    <label>
      <input type="checkbox" id="donorAvailable" />
      Ø£Ù†Ø§ Ù…ØªØ§Ø­ Ù„Ù„ØªØ¨Ø±Ø¹ Ø§Ù„Ø¢Ù†
    </label>
    <button onclick="updateDonorStatus()">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙŠ</button>
  </div>

  <div id="map"></div>

  <div class="legend">
    <strong>Ø§Ù„Ø±Ù…ÙˆØ²:</strong><br />
    ğŸ©¸ Ù…Ø­ØªØ§Ø¬ Ù„Ù„Ø¯Ù…<br />
    â¤ï¸ Ù…ØªØ¨Ø±Ø¹ Ù…ØªØ§Ø­<br />
    ğŸ¥ Ù…Ø±ÙƒØ² ØªØ¨Ø±Ø¹
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const apiBase = "http://localhost:8000"; // ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ù„Ø¹Ù†ÙˆØ§Ù† Ø³ÙŠØ±ÙØ±Ùƒ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø´Ø±
    let userId = null;

    const map = L.map("map").setView([31.7917, -7.0926], 6); // Ù…Ø±ÙƒØ² Ø§Ù„Ù…ØºØ±Ø¨

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap",
    }).addTo(map);

    const icons = {
      request: L.divIcon({
        html: "ğŸ©¸",
        iconSize: [20, 20],
        className: "icon-request",
      }),
      donor: L.divIcon({
        html: "â¤ï¸",
        iconSize: [20, 20],
        className: "icon-donor",
      }),
      center: L.divIcon({
        html: "ğŸ¥",
        iconSize: [20, 20],
        className: "icon-center",
      }),
    };

    let markers = [];

    async function fetchMapData() {
      try {
        const res = await fetch(`${apiBase}/map-data`);
        const data = await res.json();
        renderMarkers(data);
      } catch (err) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ.");
        console.error(err);
      }
    }

    function renderMarkers(data) {
      markers.forEach((m) => map.removeLayer(m));
      markers = [];
      data.forEach((entry) => {
        const marker = L.marker([entry.lat, entry.lng], {
          icon: icons[entry.type],
        }).addTo(map);

        let popup = "";
        if (entry.type === "center") {
          popup = `<strong>${entry.name}</strong>`;
        } else {
          popup = `${entry.type === "request" ? "Ù…Ø­ØªØ§Ø¬" : "Ù…ØªØ¨Ø±Ø¹"}<br>
            Ø§Ù„ÙØ¦Ø©: ${entry.blood}<br>
            Ø§Ù„Ù…Ø¹Ø±Ù: ${entry.label}`;
        }
        marker.bindPopup(popup);
        markers.push(marker);
      });
    }

    async function registerUser() {
      const phone = document.getElementById("regPhone").value.trim();
      const gender = document.getElementById("regGender").value;
      const blood = document.getElementById("regBlood").value;

      if (!phone || !blood) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆÙØ¦Ø© Ø§Ù„Ø¯Ù….");
        return;
      }

      try {
        const res = await fetch(`${apiBase}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone, gender, blood_type: blood }),
        });
        if (!res.ok) throw new Error("ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
        const data = await res.json();
        userId = data.id;
        alert(`ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${userId}`);
      } catch (err) {
        alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.");
        console.error(err);
      }
    }

    async function sendBloodRequest() {
      if (!userId) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const latlng = map.getCenter();
      const blood = document.getElementById("regBlood").value;
      if (!blood) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© Ø§Ù„Ø¯Ù….");
        return;
      }
      try {
        const res = await fetch(`${apiBase}/request-blood`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: userId,
            blood_type: blood,
            lat: latlng.lat,
            lng: latlng.lng,
            emergency: true,
          }),
        });
        if (!res.ok) throw new Error("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨");
        const data = await res.json();
        alert(data.msg);
        fetchMapData();
      } catch (err) {
        alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.");
        console.error(err);
      }
    }

    async function updateDonorStatus() {
      if (!userId) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      if (!navigator.geolocation) return alert("Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");

      const available = document.getElementById("donorAvailable").checked;

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const { latitude, longitude } = pos.coords;

          try {
            const res = await fetch(`${apiBase}/update-donor`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                user_id: userId,
                available,
                lat: latitude,
                lng: longitude,
              }),
            });
            if (!res.ok) throw new Error("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
            const data = await res.json();
            alert(data.msg);
            fetchMapData();
          } catch (err) {
            alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
            console.error(err);
          }
        },
        () => alert("ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ")
      );
    }

    // Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø¨Ø³Ø· Ù„ÙØ¦Ø© Ø§Ù„Ø¯Ù… Ø¹Ù†Ø¯ ÙˆØ±ÙˆØ¯ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
    let lastRequestIds = new Set();

    async function checkNewRequests() {
      if (!userId) return;

      try {
        const res = await fetch(`${apiBase}/map-data`);
        const data = await res.json();

        const userBlood = document.getElementById("regBlood").value;
        if (!userBlood) return;

        const newRequests = data.filter(
          (d) =>
            d.type === "request" &&
            d.blood === userBlood &&
            !lastRequestIds.has(d.label)
        );

        if (newRequests.length > 0) {
          newRequests.forEach((r) => lastRequestIds.add(r.label));
          notifyUser(newRequests.length);
        }
      } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:", err);
      }
    }

    function notifyUser(count) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted") {
        new Notification("Ù…Ù†ØµØ© Ù‚Ù„Ø¨ÙŠ", {
          body: `ÙŠÙˆØ¬Ø¯ ${count} Ø·Ù„Ø¨ Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ù„ÙØ¦Ø© Ø¯Ù…Ùƒ.`,
          icon: "https://cdn-icons-png.flaticon.com/512/2913/2913462.png",
        });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then((perm) => {
          if (perm === "granted") notifyUser(count);
        });
      }
    }

    setInterval(checkNewRequests, 30000);

    function filterMarkers() {
      const selected = document.getElementById("bloodType").value;
      fetch(`${apiBase}/map-data`)
        .then((res) => res.json())
        .then((data) => {
          if (!selected) renderMarkers(data);
          else renderMarkers(data.filter((m) => m.blood === selected));
        })
        .catch((err) => {
          alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
          console.error(err);
        });
    }

    fetchMapData();
  </script>
</body>
</html>
